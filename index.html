<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram 身份验证</title>
    <style>
        /* 样式保持不变 */
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">T</div>
        
        <h1>Telegram 身份验证</h1>
        <p class="description">
            请使用 Telegram 账号登录以验证身份<br>
            登录后将自动返回应用
        </p>
        
        <div id="telegram-login-widget"></div>
        
        <div class="footer">
            AIDR 项目身份验证系统
        </div>
    </div>
    
    <script>
        // 方法1：使用 iframe 方式
        function createTelegramWidget() {
            const widgetContainer = document.getElementById('telegram-login-widget');
            
            // 创建 iframe
            const iframe = document.createElement('iframe');
            iframe.src = 'https://telegram.org/js/telegram-widget.js';
            iframe.style.border = 'none';
            iframe.style.width = '100%';
            iframe.style.height = '60px';
            
            widgetContainer.appendChild(iframe);
        }
        
        // 方法2：使用动态脚本加载
        function loadTelegramWidget() {
            const script = document.createElement('script');
            script.src = 'https://telegram.org/js/telegram-widget.js';
            script.onload = function() {
                console.log('Telegram 脚本加载成功');
                initWidget();
            };
            script.onerror = function() {
                console.error('Telegram 脚本加载失败');
                showFallback();
            };
            document.head.appendChild(script);
        }
        
        function initWidget() {
            try {
                if (typeof window.Telegram !== 'undefined' && window.Telegram.Login) {
                    console.log('Telegram 对象可用:', window.Telegram);
                    
                    // 尝试不同的 API 方法
                    if (window.Telegram.Login.widget) {
                        window.Telegram.Login.widget(
                            document.getElementById('telegram-login-widget'),
                            {
                                data_auth_url: 'https://swepthong.github.io/telegram-login-page/auth',
                                data_onauth: function(user) {
                                    console.log('用户登录成功:', user);
                                    redirectToApp(user);
                                }
                            }
                        );
                    } else if (window.Telegram.Login.auth) {
                        window.Telegram.Login.auth(
                            document.getElementById('telegram-login-widget'),
                            {
                                data_auth_url: 'https://swepthong.github.io/telegram-login-page/auth',
                                data_onauth: function(user) {
                                    console.log('用户登录成功:', user);
                                    redirectToApp(user);
                                }
                            }
                        );
                    } else {
                        console.error('Telegram Login API 不可用');
                        showFallback();
                    }
                } else {
                    console.error('Telegram 对象未定义');
                    showFallback();
                }
            } catch (error) {
                console.error('初始化失败:', error);
                showFallback();
            }
        }
        
        function showFallback() {
            const container = document.getElementById('telegram-login-widget');
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p style="color: #666; margin-bottom: 16px;">Telegram 登录组件暂时不可用</p>
                    <button onclick="openTelegramApp()" style="
                        background: #0088cc;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                    ">
                        打开 Telegram 应用
                    </button>
                </div>
            `;
        }
        
        function openTelegramApp() {
            // 打开 Telegram 应用
            window.location.href = 'https://t.me/';
        }
        
        function redirectToApp(user) {
            const userJson = encodeURIComponent(JSON.stringify(user));
            const redirectUrl = `aidr://telegram-auth?user=${userJson}`;
            
            console.log('重定向到应用:', redirectUrl);
            
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 2000);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始加载 Telegram Widget...');
            loadTelegramWidget();
        });
    </script>
</body>
</html>